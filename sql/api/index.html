
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>SQL API Reference &#8212; OpenDP SmartNoise SQL</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Metadata" href="../metadata.html" />
    <link rel="prev" title="SmartNoise SQL" href="../index.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="http://docs.smartnoise.org">
  <img src="../_static/smartnoise-logo.svg" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 current active nav-item">
 <a class="current reference internal nav-link" href="#">
  API index
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../metadata.html">
  Metadata
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../advanced.html">
  Advanced Usage
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/opendp/smartnoise-sdk" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/opendp_org" rel="noopener" target="_blank" title="Twitter">
            <span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/opendp/opendp/discussions" rel="noopener" target="_blank" title="GitHub Discussions">
            <span><i class="far fa-comments"></i></span>
            <label class="sr-only">GitHub Discussions</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#privatereader">
   PrivateReader
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#privacy">
   Privacy
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="sql-api-reference">
<h1>SQL API Reference<a class="headerlink" href="#sql-api-reference" title="Permalink to this headline">¶</a></h1>
<dl class="py method">
<dt class="sig sig-object py" id="snsql.connect.from_connection">
<span class="sig-prename descclassname"><span class="pre">connect.</span></span><span class="sig-name descname"><span class="pre">from_connection</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">ignore</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">privacy</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">metadata</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">engine</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#snsql.connect.from_connection" title="Permalink to this definition">¶</a></dt>
<dd><p>Open a private SQL connection against an established database connection.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">snsql</span> <span class="kn">import</span> <span class="n">from_connection</span><span class="p">,</span> <span class="n">Privacy</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">pyodbc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dsn</span><span class="p">)</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="s1">&#39;datasets/PUMS.yaml&#39;</span>
<span class="n">privacy</span> <span class="o">=</span> <span class="n">Privacy</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">reader</span> <span class="o">=</span> <span class="n">from_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">privacy</span><span class="o">=</span><span class="n">privacy</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT educ, COUNT(*) AS n FROM PUMS.PUMS GROUP BY educ&#39;</span><span class="p">)</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>conn</strong> – An established database connection.  Can be pyodbc, psycopg2, spark, pandas, or presto.</p></li>
<li><p><strong>privacy</strong> – A Privacy object with the desired privacy parameters</p></li>
<li><p><strong>metadata</strong> – The metadata describing the data source.  This will typically be
a path to a yaml metadata file, but can also be a dictionary.</p></li>
<li><p><strong>engine</strong> – Specifies the engine to use.  Can be ‘sqlserver’, ‘postgres’,
‘spark’, ‘pandas’, or ‘presto’.  If not supplied, from_connection will probe
the supplied connection to decide what dialect to use.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A PrivateReader that can be used to execute differentially private
queries against the database.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="snsql.connect.from_df">
<span class="sig-prename descclassname"><span class="pre">connect.</span></span><span class="sig-name descname"><span class="pre">from_df</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">ignore</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">privacy</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">metadata</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#snsql.connect.from_df" title="Permalink to this definition">¶</a></dt>
<dd><p>Open a private SQL connection against a Pandas DataFrame.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">snsql</span> <span class="kn">import</span> <span class="n">from_df</span><span class="p">,</span> <span class="n">Privacy</span>

<span class="n">csv</span> <span class="o">=</span> <span class="s1">&#39;datasets/PUMS.csv&#39;</span>
<span class="n">pums</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv</span><span class="p">)</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="s1">&#39;datasets/PUMS.yaml&#39;</span>

<span class="n">privacy</span> <span class="o">=</span> <span class="n">Privacy</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">reader</span> <span class="o">=</span> <span class="n">from_df</span><span class="p">(</span><span class="n">pums</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">privacy</span><span class="o">=</span><span class="n">privacy</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT educ, COUNT(*) AS n FROM PUMS.PUMS GROUP BY educ&#39;</span><span class="p">)</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>df</strong> – The Pandas DataFrame to be queried</p></li>
<li><p><strong>privacy</strong> – A Privacy object with the desired privacy parameters</p></li>
<li><p><strong>metadata</strong> – The metadata describing the data source.  This will typically be
a path to a yaml metadata file, but can also be a dictionary.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A PrivateReader that can be used to execute differentially private
queries against the pandas dataframe.</p>
</dd>
</dl>
</dd></dl>

<section id="privatereader">
<h2>PrivateReader<a class="headerlink" href="#privatereader" title="Permalink to this headline">¶</a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="snsql.sql.private_reader.PrivateReader">
<em class="property"><span class="pre">class</span> </em><span class="sig-prename descclassname"><span class="pre">snsql.sql.private_reader.</span></span><span class="sig-name descname"><span class="pre">PrivateReader</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">reader</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">metadata</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">privacy</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/snsql/sql/private_reader.html#PrivateReader"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#snsql.sql.private_reader.PrivateReader" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">snsql.reader.base.Reader</span></code></p>
<p>Executes SQL queries against tabular data sources and returns differentially private results.</p>
<p>PrivateReader should be created using the <cite>from_connection</cite> method.</p>
<dl class="py property">
<dt class="sig sig-object py" id="snsql.sql.private_reader.PrivateReader.engine">
<em class="property"><span class="pre">property</span> </em><span class="sig-name descname"><span class="pre">engine</span></span><em class="property"><span class="pre">:</span> <span class="pre">str</span></em><a class="headerlink" href="#snsql.sql.private_reader.PrivateReader.engine" title="Permalink to this definition">¶</a></dt>
<dd><p>The engine being used by this private reader.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;datasets/PUMS.csv&#39;</span><span class="p">)</span>
<span class="n">reader</span> <span class="o">=</span> <span class="n">from_connection</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">privacy</span><span class="o">=</span><span class="n">privacy</span><span class="p">)</span>
<span class="k">assert</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">engine</span> <span class="o">==</span> <span class="s1">&#39;pandas&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="snsql.sql.private_reader.PrivateReader.execute">
<span class="sig-name descname"><span class="pre">execute</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">query_string</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">accuracy</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">ignore</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pre_aggregated</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">postprocess</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/snsql/sql/private_reader.html#PrivateReader.execute"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#snsql.sql.private_reader.PrivateReader.execute" title="Permalink to this definition">¶</a></dt>
<dd><p>Executes a query and returns a recordset that is differentially private.</p>
<p>Follows ODBC and DB_API convention of consuming query as a string and returning
recordset as tuples.  This is useful for cases where existing DB_API clients
want to swap out API calls with minimal changes.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>query_string</strong> – A query string in SQL syntax</p></li>
<li><p><strong>pre_aggregated</strong> – By default, <cite>execute</cite> will use the underlying database engine to compute exact aggregates.  To use exact aggregates from a different source, pass in the exact aggregates here as an iterable of tuples.</p></li>
<li><p><strong>postprocess</strong> (<em>bool</em>) – If False, the intermediate result, immediately after adding noise and censoring dimensions, will be returned.  All post-processing that does not impact privacy, such as clamping negative counts, LIMIT, HAVING, and ORDER BY, will be skipped.</p></li>
<li><p><strong>accuracy</strong> (<em>bool</em>) – </p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A recordset structured as an array of tuples, where each tuple
represents a row, and each item in the tuple is typed.  The first row will
contain column names.</p>
</dd>
</dl>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT sex, AVG(age) AS age FROM PUMS.PUMS GROUP BY sex&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="snsql.sql.private_reader.PrivateReader.execute_with_accuracy">
<span class="sig-name descname"><span class="pre">execute_with_accuracy</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">query_string</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/snsql/sql/private_reader.html#PrivateReader.execute_with_accuracy"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#snsql.sql.private_reader.PrivateReader.execute_with_accuracy" title="Permalink to this definition">¶</a></dt>
<dd><p>Executes a private SQL query, returning accuracy bounds for each column 
and row.  This should only be used if you need analytic bounds for statistics
where the bounds change based on partition size, such as AVG and VARIANCE.
In cases where simple statistics such as COUNT and SUM are used, <code class="docutils literal notranslate"><span class="pre">get_simple_accuracy</span></code>
is recommended.  The analytic bounds for AVG and VARIANCE can be quite wide,
so it’s better to determine accuracy through simulation, whenever that’s an option.</p>
<p>Executes query and advances privacy odometer.  Returns accuracies for multiple alphas,
using <code class="docutils literal notranslate"><span class="pre">alphas</span></code> property on the <code class="docutils literal notranslate"><span class="pre">Privacy</span></code> object that was passed in when the reader
was instantiated.</p>
<p>Note that the tuple format of <code class="docutils literal notranslate"><span class="pre">execute_with_accuracy</span></code> is not interchangeable with <code class="docutils literal notranslate"><span class="pre">execute</span></code>,
because the accuracy tuples need to be nested in the output rows to allow
streamed processing.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>query_string</strong> (<em>str</em>) – The query to execute.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A tuple with a dataframe showing row results, and a nested
tuple with a dataframe for each set of accuracies.  The accuracy
dataframes will have the same number of rows and columns as the
result dataframe.</p>
</dd>
</dl>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># alphas for 95% and 99% intervals</span>
<span class="n">privacy</span> <span class="o">=</span> <span class="n">Privacy</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">alphas</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
<span class="n">reader</span> <span class="o">=</span> <span class="n">from_connection</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">privacy</span><span class="o">=</span><span class="n">privacy</span><span class="p">)</span>            
<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT educ, AVG(age) AS age FROM PUMS.PUMS GROUP BY educ&#39;</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">execute_with_accuracy</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

<span class="n">age_col</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">accuracies</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
    <span class="n">acc95</span><span class="p">,</span> <span class="n">acc99</span> <span class="o">=</span> <span class="n">accuracies</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Noisy average is </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="n">age_col</span><span class="p">]</span><span class="si">}</span><span class="s1"> with 95% +/- </span><span class="si">{</span><span class="n">acc95</span><span class="p">[</span><span class="n">age_col</span><span class="p">]</span><span class="si">}</span><span class="s1"> and 99% +/- </span><span class="si">{</span><span class="n">acc99</span><span class="p">[</span><span class="n">age_col</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="snsql.sql.private_reader.PrivateReader.execute_with_accuracy_df">
<span class="sig-name descname"><span class="pre">execute_with_accuracy_df</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">query_string</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">ignore</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/snsql/sql/private_reader.html#PrivateReader.execute_with_accuracy_df"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#snsql.sql.private_reader.PrivateReader.execute_with_accuracy_df" title="Permalink to this definition">¶</a></dt>
<dd><p>Executes a private SQL query, returning accuracy bounds for each column 
and row.  This should only be used if you need analytic bounds for statistics
where the bounds change based on partition size, such as AVG and VARIANCE.
In cases where simple statistics such as COUNT and SUM are used, <code class="docutils literal notranslate"><span class="pre">get_simple_accuracy</span></code>
is recommended.  The analytic bounds for AVG and VARIANCE can be quite wide,
so it’s better to determine accuracy through simulation, whenever that’s an option.</p>
<p>Executes query and advances privacy odometer.  Returns accuracies for multiple alphas,
using <code class="docutils literal notranslate"><span class="pre">alphas</span></code> property on the <code class="docutils literal notranslate"><span class="pre">Privacy</span></code> object that was passed in when the reader
was instantiated.</p>
<p>Note that the tuple format of <code class="docutils literal notranslate"><span class="pre">execute_with_accuracy_df</span></code> is not interchangeable with 
<code class="docutils literal notranslate"><span class="pre">execute</span></code>, because the accuracy tuples need to be nested in the output rows to allow
streamed processing.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>query_string</strong> (<em>str</em>) – The query to execute.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A list of tuples, with each item in the list representing a row.
each row has a tuple of the result values, and a nested tuple with
each of the column accuracies for that row, for each alpha.</p>
</dd>
</dl>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># alphas for 95% and 99% intervals</span>
<span class="n">privacy</span> <span class="o">=</span> <span class="n">Privacy</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">alphas</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
<span class="n">reader</span> <span class="o">=</span> <span class="n">from_connection</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">privacy</span><span class="o">=</span><span class="n">privacy</span><span class="p">)</span>            
<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT educ, AVG(age) AS age FROM PUMS.PUMS GROUP BY educ&#39;</span>

<span class="n">res</span> <span class="p">(</span><span class="n">acc95</span><span class="p">,</span> <span class="n">acc99</span><span class="p">)</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">execute_with_accuracy_df</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">acc95</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">acc99</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="snsql.sql.private_reader.PrivateReader.from_connection">
<em class="property"><span class="pre">classmethod</span> </em><span class="sig-name descname"><span class="pre">from_connection</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">conn</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">ignore</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">privacy</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">metadata</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">engine</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/snsql/sql/private_reader.html#PrivateReader.from_connection"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#snsql.sql.private_reader.PrivateReader.from_connection" title="Permalink to this definition">¶</a></dt>
<dd><p>Create a private reader over an established SQL connection.  If <cite>engine</cite> is not
passed in, the engine will be automatically detected.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>conn</strong> – An established database connection.  Can be pyodbc, psycopg2, SparkSession, Pandas DataFrame, or Presto.</p></li>
<li><p><strong>privacy</strong> – A Privacy object with epsilon, delta, and other privacy properties.  Keyword-only.</p></li>
<li><p><strong>metadata</strong> – The metadata describing the database.  <a class="reference external" href="https://docs.smartnoise.org/en/stable/sql/metadata.html">Metadata documentation is here</a>.  Keyword-only.</p></li>
<li><p><strong>engine</strong> – Optional keyword-only argument that can be used to specify engine-specific rules if automatic detection fails.  This should only be necessary when using an uncommon database or middleware.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A <cite>PrivateReader</cite> object initialized to process queries against the supplied connection, using the supplied <cite>Privacy</cite> properties.</p>
</dd>
</dl>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">privacy</span> <span class="o">=</span> <span class="n">Privacy</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="s1">&#39;datasets/PUMS.yaml&#39;</span>
<span class="n">pums</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;datasets/PUMS.csv&#39;</span><span class="p">)</span>
<span class="n">reader</span> <span class="o">=</span> <span class="n">PrivateReader</span><span class="o">.</span><span class="n">from_connection</span><span class="p">(</span><span class="n">pums</span><span class="p">,</span> <span class="n">privacy</span><span class="o">=</span><span class="n">privacy</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="snsql.sql.private_reader.PrivateReader.get_privacy_cost">
<span class="sig-name descname"><span class="pre">get_privacy_cost</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">query_strings</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/snsql/sql/private_reader.html#PrivateReader.get_privacy_cost"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#snsql.sql.private_reader.PrivateReader.get_privacy_cost" title="Permalink to this definition">¶</a></dt>
<dd><p>Estimates the epsilon and delta cost for running the given query.
Privacy cost is returned without running the query or incrementing the odometer.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>query_string</strong> – The query string or strings to analyze</p></li>
<li><p><strong>query_strings</strong> (<em>Union</em><em>[</em><em>str</em><em>, </em><em>List</em><em>[</em><em>str</em><em>]</em><em>]</em>) – </p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A tuple of (epsilon, delta) estimating total privacy cost for
running this query or queries.</p>
</dd>
</dl>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># metadata specifies censor_dims: False</span>
<span class="n">privacy</span> <span class="o">=</span> <span class="n">Privacy</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">reader</span> <span class="o">=</span> <span class="n">from_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">privacy</span><span class="o">=</span><span class="n">privacy</span><span class="p">)</span>

<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT AVG(age) FROM PUMS.PUMS GROUP BY educ&#39;</span>
<span class="n">eps_cost</span><span class="p">,</span> <span class="n">delta_cost</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">get_privacy_cost</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

<span class="c1"># will be ~0.2 epsilon, since AVG computed from SUM and COUNT</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total epsilon spent will be </span><span class="si">{</span><span class="n">eps_cost</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT SUM(age), COUNT(age), AVG(age) FROM PUMS.PUMS GROUP BY educ&#39;</span>
<span class="n">eps_cost</span><span class="p">,</span> <span class="n">delta_cost</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">get_privacy_cost</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

<span class="c1"># will be ~0.2 epsilon, since noisy SUM and COUNT are re-used</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total epsilon spent will be </span><span class="si">{</span><span class="n">eps_cost</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT COUNT(*), AVG(age) FROM PUMS.PUMS GROUP BY educ&#39;</span>
<span class="n">eps_cost</span><span class="p">,</span> <span class="n">delta_cost</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">get_privacy_cost</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

<span class="c1"># will be ~0.3 epsilon, since COUNT(*) and COUNT(age) can be different</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total epsilon spent will be </span><span class="si">{</span><span class="n">eps_cost</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="snsql.sql.private_reader.PrivateReader.get_simple_accuracy">
<span class="sig-name descname"><span class="pre">get_simple_accuracy</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">query_string</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alpha</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/snsql/sql/private_reader.html#PrivateReader.get_simple_accuracy"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#snsql.sql.private_reader.PrivateReader.get_simple_accuracy" title="Permalink to this definition">¶</a></dt>
<dd><p>Return accuracy for each alpha and each mechanism in column order.
Columns with no mechanism application return None.  Returns accuracy
without running the query.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>query_string</strong> (<em>str</em>) – The SQL query</p></li>
<li><p><strong>alpha</strong> (<em>float</em>) – The desired accuracy alpha.  For example, alpha of 0.05 will
return a 95% interval.</p></li>
</ul>
</dd>
</dl>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">reader</span> <span class="o">=</span> <span class="n">from_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">privacy</span><span class="o">=</span><span class="n">privacy</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT COUNT(*) AS n, SUM(age) AS age FROM PUMS.PUMS GROUP BY income&#39;</span>

<span class="n">accuracy</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">get_simple_accuracy</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;For 95% of query executions, n will be within +/- </span><span class="si">{</span><span class="n">accuracy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> of true value&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;For 95% of query executions, age will be within +/- </span><span class="si">{</span><span class="n">accuracy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> of true value&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="snsql.sql.private_reader.PrivateReader.parse_query_string">
<span class="sig-name descname"><span class="pre">parse_query_string</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">query_string</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/snsql/sql/private_reader.html#PrivateReader.parse_query_string"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#snsql.sql.private_reader.PrivateReader.parse_query_string" title="Permalink to this definition">¶</a></dt>
<dd><p>Parse a query string, returning an AST <cite>Query</cite> object.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">reader</span> <span class="o">=</span> <span class="n">from_connection</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">privacy</span><span class="o">=</span><span class="n">privacy</span><span class="p">)</span>
<span class="n">query_string</span> <span class="o">=</span> <span class="s1">&#39;SELECT STDDEV(age) AS age FROM PUMS.PUMS&#39;</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">parse_query_string</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
<span class="n">age_node</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">xpath_first</span><span class="p">(</span><span class="s2">&quot;//NamedExpression[@name=&#39;age&#39;]&quot;</span><span class="p">)</span>
<span class="n">dot</span> <span class="o">=</span> <span class="n">age_node</span><span class="o">.</span><span class="n">visualize</span><span class="p">()</span> <span class="c1"># visualize the formula in the AST</span>
<span class="n">dot</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>snsql._ast.ast.Query</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</section>
<section id="privacy">
<h2>Privacy<a class="headerlink" href="#privacy" title="Permalink to this headline">¶</a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="snsql.sql.privacy.Privacy">
<em class="property"><span class="pre">class</span> </em><span class="sig-prename descclassname"><span class="pre">snsql.sql.privacy.</span></span><span class="sig-name descname"><span class="pre">Privacy</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">ignore</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">epsilon</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">delta</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1e-15</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alphas</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">[]</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mechanisms</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/snsql/sql/privacy.html#Privacy"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#snsql.sql.privacy.Privacy" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<p>Privacy parameters.  The Privacy object is passed in when creating
any private SQL connection, and applies to all queries executed against that
connection.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>epsilon</strong> (<em>float</em>) – The epsilon value for each statistic returned by the private SQL connection.</p></li>
<li><p><strong>delta</strong> (<em>float</em>) – The delta value for each query processed by the private SQL connection.  Most counts and sums will use delta of 0, but dimension
censoring and Gaussian mechanism require delta.  Set delta to something like
1/n*sqrt(n), where n is the approximate number of rows in the data source.</p></li>
<li><p><strong>alphas</strong> (<em>List</em><em>[</em><em>float</em><em>]</em>) – A list of floats representing desired accuracy bounds.  Only set this parameter if you plan
to use execute_with_accuracy for row-based accuracy.  For simple column accuracy bounds, you can pass
an alpha directly to get_simple_accuracy, which ignores these alphas.</p></li>
<li><p><strong>mechanisms</strong> (<em>snsql.sql.privacy.Mechanisms</em>) – A property bag specifying which mechanisms to use for which
types of statistics.  You will only set this parameter if you want to override
default mechanism mapping.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="../index.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">SmartNoise SQL</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../metadata.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Metadata</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.1.2.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>